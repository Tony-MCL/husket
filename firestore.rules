// ===============================
// firestore.rules
// Husket Sky v1 – LÅST kontrakt
// ===============================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthed() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthed() && request.auth.uid == uid;
    }

    // -------------------------------
    // users root doc
    // -------------------------------
    match /users/{uid} {
      allow read: if isOwner(uid);
      allow write: if false;

      // Sky backup huskets
      match /huskets/{husketId} {
        allow read, create, update: if isOwner(uid);
        allow delete: if false; // tombstone only
      }

      // contacts: server only writes
      match /contacts/{contactUid} {
        allow read: if isOwner(uid);
        allow create, update, delete: if false;
      }

      // counters: server only writes
      match /counters/{yyyymm} {
        allow read: if isOwner(uid);
        allow write: if false;
      }
    }

    // -------------------------------
    // relay: recipient read only
    // -------------------------------
    match /relay/{relayId} {
      allow read: if isAuthed() &&
                   resource.data.recipientUid == request.auth.uid;

      allow create, update, delete: if false; // server only
    }

    // (server-only) invite codes (valgfri, men anbefalt)
    // clients should never access
    match /inviteCodes/{code} {
      allow read, write: if false;
    }
  }
}
